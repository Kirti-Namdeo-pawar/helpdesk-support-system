<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Tickets</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<nav class="navbar navbar-dark bg-dark">
    <div class="container">
        <span id="userDisplay" class="text-light"></span>
    </div>
</nav>

<div class="container mt-5">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary">üéüÔ∏è Support Ticket Dashboard</h2>
        <div>
            <button class="btn btn-success me-2" onclick="window.location.href='create-ticket.html'">‚ûï Create Ticket</button>
            <button class="btn btn-outline-secondary" onclick="window.location.href='tickets.html'">üìã View All Tickets</button>
        </div>
    </div>

    <!-- User ID Search -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">üîç Search Tickets by User ID</h5>
            <div class="input-group" style="max-width: 400px;">
                <input type="number" id="userIdInput" class="form-control" placeholder="Enter User ID">
                <button class="btn btn-primary" onclick="getTicketsByUserId()">Fetch</button>
            </div>
        </div>
    </div>

    <!-- Status Filter -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">üéØ Filter Tickets by Status</h5>
            <div class="input-group" style="max-width: 400px;">
                <select id="statusFilter" class="form-select" onchange="filterTicketsByStatus()">
                    <option value="">-- Select Status --</option>
                    <option value="Open">Open</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Closed">Closed</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Tickets Table -->
    <div class="card shadow-sm">
        <div class="card-body">
            <h5 class="card-title mb-3">üìã Tickets</h5>
            <table class="table table-bordered table-hover text-center align-middle">
                <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="ticketTableBody">
                <tr><td colspan="4" class="text-muted">No tickets loaded yet</td></tr>
                </tbody>
            </table>
            <button class="btn btn-outline-secondary mt-3" onclick="getAllTickets()">üîÅ Back to All Tickets</button>
        </div>
    </div>
</div>

<script>
    const API_BASE = "http://localhost:8080/api/tickets";

    // Fetch All Tickets
    async function getAllTickets() {
        const response = await fetch(API_BASE);
        const tickets = await response.json();
        renderTickets(tickets);
    }

    // Fetch Tickets by User ID
    async function getTicketsByUserId() {
        const userId = document.getElementById('userIdInput').value.trim();
        if (!userId) return alert("Please enter a User ID");
        const response = await fetch(`${API_BASE}/user/${userId}`);
        const tickets = await response.json();
        renderTickets(tickets);
    }

    // Filter Tickets by Status
    async function filterTicketsByStatus() {
        const status = document.getElementById('statusFilter').value;
        if (!status) return getAllTickets(); // show all if no filter selected
        const response = await fetch(`${API_BASE}/status/${status}`);
        const tickets = await response.json();
        renderTickets(tickets);
    }

    // Render Tickets Table
    function renderTickets(tickets) {
        const tableBody = document.getElementById("ticketTableBody");
        tableBody.innerHTML = "";
        if (tickets.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="4" class="text-muted">No tickets found</td></tr>`;
            return;
        }
        tickets.forEach(ticket => {
            tableBody.innerHTML += `
                <tr>
                    <td>${ticket.id}</td>
                    <td>${ticket.title}</td>
                    <td>
                        <span class="badge bg-${getStatusColor(ticket.status)}">${ticket.status}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="updateStatus(${ticket.id})">Update Status</button>
                    </td>
                </tr>
            `;
        });
    }

    // Helper for badge colors
    function getStatusColor(status) {
        switch (status) {
            case "Open": return "primary";
            case "In Progress": return "info";
            case "Closed": return "success";
            default: return "secondary";
        }
    }

    // Update ticket status (PUT request)
    async function updateStatus(ticketId) {
        const newStatus = prompt("Enter new status (Open / In Progress / Closed):");
        if (!newStatus) return;
        await fetch(`${API_BASE}/${ticketId}/status`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status: newStatus })
        });
        alert("Status updated successfully!");
        getAllTickets();
    }

    // Load all tickets by default
    getAllTickets();
</script>

<script>
    const user = JSON.parse(localStorage.getItem("loggedInUser"));
    if (!user) {
        window.location.href = "index.html"; // force login
    } else {
        document.getElementById("userDisplay").textContent = `Welcome, ${user.username}`;
    }
</script>
</body>
</html>
